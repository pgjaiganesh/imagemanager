#!/bin/bash
#used for testing

set -o errexit

. ./bin/config
stack_name=TestManagerFunction

aws configure set default.region $deployment_region
region="$(aws configure get region)"

set -o xtrace

sed -e "s/REGION/${region}/g" \
  cloudformation/test.yaml > deploy/test.yaml

sed -e "s/REGION/${region}/g" \
  cloudformation/test-update.yaml > deploy/test-update.yaml

aws s3 mb "s3://${code_bucket_name}"

aws cloudformation package \
  --output-template-file=deploy/output-test.yaml \
  --template-file=deploy/test.yaml \
  --s3-bucket="${code_bucket_name}" \

aws cloudformation deploy \
  --template-file=deploy/output-test.yaml \
  --stack-name="${stack_name}" \
  --capabilities=CAPABILITY_NAMED_IAM

aws cloudformation describe-stacks \
  --stack-name "${stack_name}" \
  --query Stacks[].Outputs \
  --output table

# aws cloudformation package \
#   --output-template-file=deploy/output-test-update.yaml \
#   --template-file=deploy/test-update.yaml \
#   --s3-bucket="${code_bucket_name}"
#
# aws s3 cp deploy/output-test-update.yaml "s3://${code_bucket_name}" --acl public-read

#--template-url=https://s3.ap-south-1.amazonaws.com/$code_bucket_name/output-test-update.yaml \
#--template-file=deploy/output-test-update.yaml \

# aws cloudformation create-change-set --change-set-name "change-set-$(openssl rand -hex 8)" \
#   --template-url=https://s3.ap-south-1.amazonaws.com/$code_bucket_name/output-test-update.yaml \
#   --stack-name="${stack_name}" \
#   --capabilities=CAPABILITY_NAMED_IAM
#
# aws cloudformation deploy \
#   --template-file=deploy/output-test-update.yaml \
#   --stack-name="${stack_name}" \
#   --capabilities=CAPABILITY_NAMED_IAM
#
# aws s3 rb --force "s3://${code_bucket_name}"
#
# aws cloudformation describe-stacks \
#   --stack-name "${stack_name}" \
#   --query Stacks[].Outputs \
#   --output table
