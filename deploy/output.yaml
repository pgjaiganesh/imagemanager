AWSTemplateFormatVersion: 2010-09-09
Outputs:
  APIGWUrl:
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-APIGWUrl
    Value:
      Fn::Sub: https://${Api}.execute-api.${AWS::Region}.amazonaws.com/prod
  BucketWebsiteUrl:
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-BucketWebsiteUrl
    Value:
      Fn::GetAtt:
      - IMAGEBUCKET
      - WebsiteURL
  ImageBucket:
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ImageBucket
    Value:
      Ref: IMAGEBUCKET
Resources:
  Api:
    Properties:
      DefinitionUri: s3://temp-code-imageresize-603dc2b8a1824080/ac5d9eab615e9f70b3980477c60bce70
      StageName: prod
      Variables:
        LambdaFunctionName:
          Ref: ResizeFunction
    Type: AWS::Serverless::Api
  IMAGEBUCKET:
    DeletionPolicy: Retain
    Properties:
      AccessControl: PublicRead
      WebsiteConfiguration:
        IndexDocument: index.html
    Type: AWS::S3::Bucket
  ImageBucketPolicy:
    Properties:
      Bucket:
        Ref: IMAGEBUCKET
      PolicyDocument:
        Statement:
        - Action:
          - s3:GetObject
          Effect: Allow
          Principal: '*'
          Resource:
            Fn::Sub: arn:aws:s3:::${IMAGEBUCKET}/*
    Type: AWS::S3::BucketPolicy
  ResizeFunction:
    Properties:
      CodeUri: s3://temp-code-imageresize-603dc2b8a1824080/97e8cab3ab7cacf7559bb0166fb9f042
      Environment:
        Variables:
          BUCKET:
            Ref: IMAGEBUCKET
      Handler: index.handler
      MemorySize: 1536
      Policies:
        Statement:
          Action:
          - s3:GetObject
          - s3:PutObject
          Effect: Allow
          Resource:
            Fn::Sub: arn:aws:s3:::${IMAGEBUCKET}/*
      Runtime: nodejs6.10
      Timeout: 1
    Type: AWS::Serverless::Function
  ResizeFunctionPermission:
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: ResizeFunction
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${Api}/*
    Type: AWS::Lambda::Permission
Transform: AWS::Serverless-2016-10-31
